<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="/stylesheets/style.css">
    <link rel="stylesheet" href="/stylesheets/font-awesome-4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://npmcdn.com/tether@1.2.4/dist/js/tether.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>

</head>

<body>
    <!-- Navigation -->
    <% include ./partials/_navbar %>

        <!-- Page Content -->
        <div class="jumbotron" style="margin:30px">
            <h6 class="lead">Manage Your Connections</h6>
            <hr class="my-2">
            <p>Search for friends by their first and last names or their email address.</p>
            <form>
                <div class="form-group d-flex justify-content-center p-4">
                    <input class="form-control col-sm-6 mr-sm-2 search-friend" type="text" placeholder="Find friends">
                    <button class="btn btn-outline-dark my-2 my-sm-0 fire-button create-list">Search</button>
                </div>
            </form>
            <div>
                <table>
                    <tr class="search-row">
                        <td class="search-name"></td>
                        <td class="search-email"></td>
                        <td class="add-button"></td>
                    </tr>
                </table>
            </div>
            <div class="panel-body">
                <div class="row-lg">
                    <ul class="list-group">
                        <% for (var i = 0; i < first.length; i++) { %>
                        <li class="list-group-item flex-column justify-content-between">
                            <h6>
                                <%= first[i] %> <%= last[i] %>
                            </h6>
                            <small>
                                <%= email[i] %>
                            </small>
                            <span class="action-buttons">
                                <i class="fa fa-minus-square-o p-2 delete-friend" aria-hidden="true" data-user-id="<%= userId[i] %>"></i>
                            </span>
                        </li>
                        <% } %>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <% include ./partials/_footer %>
</body>

</html>

<script>
    $(function () {

        $('.fire-button').on('click', function (event) {
            event.preventDefault();
            let input = $('.search-friend').val();
            
            $.ajax({
                type: 'get',
                url: '/connections/search',
                data: { input: input },
                success: function(results) {
                    let newResults = JSON.parse(results);
                    let name = $('.search-name').text(newResults[0].first_name + (' ') + (newResults[0].last_name));
                    let email = $('.search-email').text(newResults[0].email);
                    let addFriend = $('.friend-add').add('<i class="fa fa-plus friend-add" data-my-id="<%= userId[0] %>" aria-hidden="true"></i>').attr('data-friend-id', newResults[0].id);

                    $('.search-row').append(name, email, addFriend);
                    
                    $('.friend-add').on('click', function () {
                        var myId = 1;
                        var friendId = Number($(this).data('friend-id'));
                        console.log(myId, friendId);
                        $('.search-friend').val('');
                        $.ajax({
                            type: 'post',
                            url: '/connections/add',
                            data: { myId, friendId }
                        /*  success: function (result) {
                                $.ajax({
                                    type: 'get',
                                    url: '/connections/add',
                                    data: { myId: 1 },
                                    success: function (result){
                                        let friends = JSON.parse(result);
                                        console.log(friends);
                                    }
                                }) 
                            },
                            failure: function(err) {
                            }

                        */
                        });
                        $('.search-row').remove();
                    });
                }
            })
        });

        $(".list-group-item").each(function () {
            const groupItem = this;
            $(this).on("click", ".delete-friend", function () {
                const user = Number($(this).data('user-id'));
                
                // const email = ($(this).data('email-id'));
                
                $.ajax({
                    type: 'post',
                    url: '/connections/delete',
                    data: { user },
                    success: function (result) {
                    },
                    failure: function(err) {
                    }
                });
                groupItem.remove()
            });
        });
    });
</script>